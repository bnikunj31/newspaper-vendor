<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="/node_modules/bootstrap/dist/css/bootstrap.min.css"
    />
    <title>All Users</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      table thead th {
        cursor: pointer;
      }
      .highlight {
        background-color: #e2e6ea !important;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <%- include('../navbar.html') %>

    <div class="container my-5">
      <div class="row mb-4">
        <div class="col-md-6 d-flex align-items-center justify-content-between">
          <h2 class="text-primary">All Customers</h2>
          <a href="/add" class="btn btn-outline-primary">Add Customer</a>
        </div>
        <div class="col-md-6 text-end">
          <input
            id="searchInput"
            class="form-control"
            type="text"
            placeholder="Search users..."
          />
        </div>
      </div>
      <table class="table table-bordered table-hover table-striped">
        <thead class="table-dark">
          <tr>
            <th data-sort="id">Id <i class="fas fa-sort"></i></th>
            <th data-sort="name">Name <i class="fas fa-sort"></i></th>
            <th>Address</th>
            <th>Contact Number</th>
            <th>Colony</th>
            <th data-sort="paid">Paid <i class="fas fa-sort"></i></th>
            <th data-sort="due">Due <i class="fas fa-sort"></i></th>
            <th>Route</th>
            <th>Last Active</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% if(rows.length > 0) { %> <% rows.forEach(row => { %>
          <tr>
            <td><%= row.customerId %></td>
            <td><%= row.customerName %></td>
            <td><%= row.address %></td>
            <td><%= row.contactNumber %></td>
            <td><%= row.colony %></td>
            <td><%= row.paid %></td>
            <td><%= row.due %></td>
            <td><%= row.route %></td>
            <td><%= row.lastActive %></td>
            <td>
              <a
                href="/update/<%= row.customerId %>"
                class="btn btn-sm btn-outline-warning"
                >Update</a
              >
              <% if(row.disable === 0 ) { %>
              <button
                class="btn btn-sm btn-outline-dark"
                data-bs-toggle="modal"
                data-bs-target="#disableModal<%= row.customerId %>"
              >
                Disable
              </button>
              <% } else { %>
              <button
                class="btn btn-sm btn-outline-success"
                data-bs-toggle="modal"
                data-bs-target="#enableModal<%= row.customerId %>"
              >
                Enable
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#deleteModal<%= row.customerId %>"
              >
                Delete
              </button>
              <% } %>
            </td>
          </tr>

          <!-- Disable Modal -->
          <div
            class="modal fade"
            id="disableModal<%= row.customerId %>"
            tabindex="-1"
            aria-labelledby="disableModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="disableModalLabel">
                    Confirm Disable
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to disable this customer?
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancel
                  </button>
                  <a href="/disable/<%= row.customerId %>" class="btn btn-dark"
                    >Disable</a
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Enable Modal -->
          <div
            class="modal fade"
            id="enableModal<%= row.customerId %>"
            tabindex="-1"
            aria-labelledby="enableModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="enableModalLabel">
                    Confirm Enable
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to enable this customer?
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancel
                  </button>
                  <a
                    href="/enable/<%= row.customerId %>"
                    class="btn btn-success"
                    >Enable</a
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Delete Modal -->
          <div
            class="modal fade"
            id="deleteModal<%= row.customerId %>"
            tabindex="-1"
            aria-labelledby="deleteModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel">
                    Confirm Delete
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to delete this customer?
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancel
                  </button>
                  <a href="/delete/<%= row.customerId %>" class="btn btn-danger"
                    >Delete</a
                  >
                </div>
              </div>
            </div>
          </div>

          <% }) %> <% } %>
        </tbody>
      </table>
      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Search functionality
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("keyup", function () {
        const filter = searchInput.value.toLowerCase();
        const rows = document.querySelectorAll("#userTableBody tr");
        rows.forEach((row) => {
          const name = row.cells[1].textContent.toLowerCase();
          row.style.display = name.includes(filter) ? "" : "none";
        });
      });

      // Pagination
      const rowsPerPage = 50;
      let currentPage = 1;
      const rows = document.querySelectorAll("#userTableBody tr");
      const pagination = document.getElementById("pagination");

      function displayRows(page) {
        currentPage = page;
        rows.forEach((row, index) => {
          row.style.display =
            index >= (currentPage - 1) * rowsPerPage &&
            index < currentPage * rowsPerPage
              ? ""
              : "none";
        });
      }

      function setupPagination() {
        const pageCount = Math.ceil(rows.length / rowsPerPage);
        pagination.innerHTML = "";
        for (let i = 1; i <= pageCount; i++) {
          const li = document.createElement("li");
          li.classList.add("page-item");
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", function (e) {
            e.preventDefault();
            displayRows(i);
            document
              .querySelectorAll(".page-item")
              .forEach((item) => item.classList.remove("active"));
            li.classList.add("active");
          });
          if (i === currentPage) {
            li.classList.add("active");
          }
          pagination.appendChild(li);
        }
      }

      // Sorting functionality
      const headers = document.querySelectorAll("th[data-sort]");
      headers.forEach((header) => {
        header.addEventListener("click", () => {
          const sortKey = header.getAttribute("data-sort");
          const sortedRows = Array.from(rows).sort((a, b) => {
            const valA = a
              .querySelector(`td:nth-child(${header.cellIndex + 1})`)
              .textContent.trim();
            const valB = b
              .querySelector(`td:nth-child(${header.cellIndex + 1})`)
              .textContent.trim();
            return isNaN(valA) || isNaN(valB)
              ? valA.localeCompare(valB)
              : parseFloat(valA) - parseFloat(valB);
          });
          sortedRows.forEach((row) =>
            document.querySelector("#userTableBody").appendChild(row)
          );
        });
      });

      // Initial setup
      displayRows(1);
      setupPagination();
    </script>
  </body>
</html>
