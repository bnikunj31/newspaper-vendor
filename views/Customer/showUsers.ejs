<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="/node_modules/bootstrap/dist/css/bootstrap.min.css"
    />
    <link
      href="/node_modules/select2/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <title>All Users</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      table thead th {
        cursor: pointer;
      }
      .highlight {
        background-color: #e2e6ea !important;
      }
      .filter-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .select2-container {
        width: 200px !important;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <%- include('../navbar.html') %>

    <div class="container my-5">
      <div class="row mb-4">
        <div
          class="col-md-12 d-flex align-items-center justify-content-between w-100"
        >
          <h2 class="text-primary">All Customers</h2>

          <!-- Search Users -->
          <input
            id="searchInput"
            class="form-control w-25"
            type="text"
            placeholder="Search users..."
          />

          <!-- Route Filter -->
          <input
            id="routeFilter"
            class="form-control w-25"
            type="text"
            placeholder="Filter by Route"
          />
          <a href="/add" class="btn btn-outline-primary">Add Customer</a>
        </div>
        <div class="filter-container mt-3">
          <span class="fw-bolder">Filter:</span>
          <!-- Colony Filter -->
          <select id="colonyFilter" class="form-control">
            <option value="">All Colonies</option>
            <% rows.forEach(colony => { %>
            <option value="<%= colony.colony %>"><%= colony.colony %></option>
            <% }) %>
          </select>

          <!-- Last Active Filter -->
          <input
            id="lastActiveFilter"
            class="form-control w-25"
            type="date"
            placeholder="Filter by Last Active (YYYY-MM-DD)"
          />

          <!-- Paid Filter -->
          <input
            id="paidFilter"
            class="form-control w-25"
            type="text"
            placeholder="Filter by Paid"
          />

          <!-- Due Filter -->
          <input
            id="dueFilter"
            class="form-control w-25"
            type="text"
            placeholder="Filter by Due"
          />

          <!-- Defaulter Filter Checkbox -->
          <div class="form-check">
            <input
              type="checkbox"
              id="defaulterFilter"
              class="form-check-input"
            />
            <label class="form-check-label" for="defaulterFilter"
              >Defaulters</label
            >
          </div>
        </div>
      </div>
      <table class="table table-bordered table-hover table-striped">
        <thead class="table-dark">
          <tr>
            <th data-sort="id">Id <i class="fas fa-sort"></i></th>
            <th data-sort="name">Name <i class="fas fa-sort"></i></th>
            <th>Address</th>
            <th>Contact Number</th>
            <th>Colony</th>
            <th data-sort="paid">Paid <i class="fas fa-sort"></i></th>
            <th data-sort="due">Due <i class="fas fa-sort"></i></th>
            <th>Route</th>
            <th>Last Active</th>
            <th>Defaulter</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% if(rows.length > 0) { %> <% rows.forEach(row => { %>
          <tr>
            <td><%= row.customerId %></td>
            <td><%= row.customerName %></td>
            <td><%= row.address %></td>
            <td><%= row.contactNumber %></td>
            <td><%= row.colony %></td>
            <td><%= row.paid %></td>
            <td><%= row.due %></td>
            <td><%= row.route %></td>
            <td><%= row.lastActive %></td>
            <td class="text-center">
              <input type="checkbox" name="defaulter" class="check" disabled
              id="defaulter" <%= row.defaulter === 1 ? "checked" : "" %> >
            </td>
            <td>
              <a
                href="/update/<%= row.customerId %>"
                class="btn btn-sm btn-outline-warning"
                >Update</a
              >
              <% if(row.disable === 0 ) { %>
              <button
                class="btn btn-sm btn-outline-dark"
                data-bs-toggle="modal"
                data-bs-target="#disableModal<%= row.customerId %>"
              >
                Disable
              </button>
              <% } else { %>
              <button
                class="btn btn-sm btn-outline-success"
                data-bs-toggle="modal"
                data-bs-target="#enableModal<%= row.customerId %>"
              >
                Enable
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#deleteModal<%= row.customerId %>"
              >
                Delete
              </button>
              <% } %>
            </td>
          </tr>
          <% }) %> <% } %>
        </tbody>
      </table>
      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/select2/dist/js/select2.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#colonyFilter").select2();

        // Filter functionality
        function filterTable() {
          const colonyFilter = $("#colonyFilter").val();
          const routeFilter = $("#routeFilter").val().toLowerCase();
          const searchInput = $("#searchInput").val().toLowerCase();
          const lastActiveFilter = $("#lastActiveFilter").val();
          const paidFilter = $("#paidFilter").val();
          const dueFilter = $("#dueFilter").val();
          const defaulterFilter = $("#defaulterFilter").is(":checked");

          // Get all rows
          const rows = $("#userTableBody tr");
          rows.each(function () {
            const row = $(this);
            const colonyText = row.find("td").eq(4).text();
            const routeText = row.find("td").eq(7).text();
            const nameText = row.find("td").eq(1).text();
            const lastActiveText = row.find("td").eq(8).text();
            const paidText = row.find("td").eq(5).text();
            const dueText = row.find("td").eq(6).text();
            const isDefaulter = row
              .find("td")
              .eq(9)
              .find("input")
              .is(":checked");

            const isColonyMatch =
              colonyFilter === "" || colonyText === colonyFilter;
            const isRouteMatch = routeText.toLowerCase().includes(routeFilter);
            const isNameMatch = nameText.toLowerCase().includes(searchInput);
            const isLastActiveMatch =
              lastActiveFilter === "" ||
              lastActiveText.includes(lastActiveFilter);
            const isPaidMatch =
              paidFilter === "" || paidText.includes(paidFilter);
            const isDueMatch = dueFilter === "" || dueText.includes(dueFilter);
            const isDefaulterMatch = !defaulterFilter || isDefaulter;

            const isVisible =
              isColonyMatch &&
              isRouteMatch &&
              isNameMatch &&
              isLastActiveMatch &&
              isPaidMatch &&
              isDueMatch &&
              isDefaulterMatch;

            row.toggle(isVisible);
          });

          setupPagination();
        }

        // Event listeners for filters
        $("#colonyFilter").change(filterTable);
        $("#routeFilter").on("input", filterTable);
        $("#searchInput").on("input", filterTable);
        $("#lastActiveFilter").on("input", filterTable);
        $("#paidFilter").on("input", filterTable);
        $("#dueFilter").on("input", filterTable);
        $("#defaulterFilter").change(filterTable);

        // Pagination logic
        const rowsPerPage = 50;
        let currentPage = 1;

        function displayRows(page) {
          currentPage = page;
          const visibleRows = $("#userTableBody tr:visible");
          visibleRows.each(function (index) {
            $(this).toggle(
              index < rowsPerPage * page && index >= rowsPerPage * (page - 1)
            );
          });
        }

        function setupPagination() {
          const visibleRows = $("#userTableBody tr:visible").length;
          const totalPages = Math.ceil(visibleRows / rowsPerPage);
          $("#pagination").empty();
          for (let i = 1; i <= totalPages; i++) {
            $("#pagination").append(
              `<li class="page-item ${i === currentPage ? "active" : ""}">
                <a class="page-link" href="#">${i}</a>
              </li>`
            );
          }
        }

        $("#pagination").on("click", "a", function (e) {
          e.preventDefault();
          const page = parseInt($(this).text());
          displayRows(page);
        });

        filterTable();
      });
    </script>
  </body>
</html>
